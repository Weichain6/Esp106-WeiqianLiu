---
title: "Lab 6"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#path <- "...."
#knitr::opts_knit$set(root.dir = path)
#setwd(path)
install.packages("terra")
```

## Before you start

Read a [short introduction](https://rspatial.org/spatial/index.html) to spatial data in R.  

There are a lot of questions. At first, do not spend too much time on making the perfect maps (you can come back to that later)

## Introduction

In this lab we will use some GPS tracking data for Blue Whales in the eastern North Pacific, downloaded from Movebank <https://www.movebank.org> which has lots of wildlife tracking data. We will make some maps and overlay polygons of Marine Protected Areas off the California coast to understand how whales move into and out of MPAs.

## Whale data

1. Use `terra::vect` to read in the datapoints for the Blue Whale migration data ("points.shp"). 

```{r blue}
library(terra)
bluew <- vect("points.shp")
bluew
```

This is a set of point location for GPS tagged blue whales the eastern north Pacific. Identifiers for individual whales are given in the ind_ident column. 

2) How many observations are there in this dataset? And how many individual whales are tracked? 

```{r nobs}
# Number of observations
num_obs <- nrow(bluew)
print(paste("Number of observations:", num_obs))

# Number of individual 
num_whales <- length(unique(bluew$ind_ident))
print(paste("Number of individual whales:", num_whales))
```

## Mapping whales

3. Get the global country boundaries with the geodata package 

```{r wrld}
wrld <- geodata::world(path=".")
```


4. Make a plot showing the whale observations, using a different color for each whale (many colors will be alike). Add the west coast of North America for reference. Set the limits of the plot to the extent of the whale migration data. 

Refine the below. Plot 1 on canvas shows you what you can aim for.

```{r plotobs}
# Step 1. plot the countries using the extent of the whale data to only show the area of interest. 

# the area of interest
aoi <- ext(bluew) + 2

plot(wrld, ext=aoi, col="lightgrey")

#Step 2: plot the whale points. You can use either the "points" method or "plot( , add=TRUE)". The latter is easier for coloring, but you need to tell it not to add a legend.

plot(bluew, "ind_ident", add=TRUE, legend=FALSE)
```

5) make new SpatVectors for each of the following two individuals: "2008CA-Bmu-00825" and "2005CA-Bmu-10821"

```{r spatv}
# 2008CA-Bmu-00825
whale1 <- bluew[bluew$ind_ident == "2008CA-Bmu-00825", ]

# 2005CA-Bmu-10821
whale2 <- bluew[bluew$ind_ident == "2005CA-Bmu-10821", ]
```

6) Combine these two into one new SpatVector 

```{r comb}

whales_bind<- rbind(whale1, whale2)
```


7) Make a map showing the tracks of these two using different colors. See plot2 on Canvas for an example.

```{r tracks}
e <- ext(whales_bind) + 2

plot(wrld, ext=e, col="lightgrey", main="Tracks of Two Individuals")

plot(whales_bind, "ind_ident", col=c("blue", "red"), add=TRUE)
```

## Protected areas

8) The folder MPAs has a shapefile with polygons for Marine Protected Areas within the United States. This file was extracted from a file with all protected areas in the US [source](https://www.protectedplanet.net). Read the MPA shapefile. 

```{r PAs}
mpa <- vect("mpas.shp")
```

9) Now we will focus on just the US west coast. You can use the following longitude and latitude extent: xmin=-128, xmax=-115, ymin=32, ymax=40. Get just the MPAs on the US west coast by cropping the MPA dataset to this extent.

```{r ext}
#Hint: use the crop() function
mpa <- crop(mpa, ext(-128, -115, 32, 40))
plot(mpa)
```

10) Find the fraction of the blue whale observations that are in one of the west coast MPAs. You can use `is.related`
```{r}
all_mpa <- aggregate(mpa)
inside <- is.related(bluew, all_mpa, "intersects")

mean(inside)
```

11) Find what fraction of blue whales in the dataset spend at least some time in one of these west coast MPAs. 

```{r fracMPA}
d <- data.frame(id = bluew$ind_ident, in_mpa = inside)

whales_least_t <- aggregate(d$in_mpa, by=list(d$id), FUN=max)

mean(whales_least_t $x)
```


12. Create a raster with counts of blue whale observations along the California coast. Use the spatial extent we used for the mpa data (question 8) and use a spatial resolution of 1/6th of a degree. First create an empty SpatRaster. Then use `rasterize`

```{r rcount}
e <- ext(-128, -115, 32, 40)
r <- rast(e, res=1/6)
r <- rasterize(bluew, r, fun="count")
r
```

13. Make a map to show the counts and the MPAs and land areas. Plot 3 on Canvas shows you the plot you are aiming for. 

```{r countmap}
plot(r, main="Blue Whale Observation Counts")
plot(wrld, add=TRUE, col="grey")
plot(mpa, add=TRUE, border="red")
```

14) Using a subset of the country boundaries (to speed up computations), create a raster with the distance to the coast, using the raster with the number of observations as template.

```{r distcoast}
coast <- crop(wrld, ext(r)+1)

dist_coast <- distance(r, coast)

plot(dist_coast, main="Distance to Coast")
```

15) For each blue whale observation, find the distance to the coast based on this raster (you can use `terra::extract`). Make a histogram of the distribution. 

```{r extract}
whale_dist <- extract(dist_coast, bluew)

hist(whale_dist[,2], main="Distance to Coast", xlab="Distance (m)")
```

